<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Clientes</title>
    <!-- Incluye Bootstrap CSS desde un CDN -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Incluye Font Awesome 6 desde un CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <!-- Incluye SweetAlert2 desde un CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f8f9fa; /* Fondo gris claro */
            color: #333; /* Color de texto oscuro */
        }
        .container {
            margin-top: 20px;
            background-color: #ffffff; /* Fondo blanco para el card */
            border-radius: 8px; /* Bordes redondeados */
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Sombra ligera */
        }
        .card {
            margin-top: 20px;
        }
        .card-header {
            background-color: #007bff;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-body {
            background-color: #f1f3f5;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .btn-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        #searchInput {
            width: 250px;
        }
        .client-item {
            cursor: pointer;
            color: #007bff;
        }
        .client-item:hover {
            text-decoration: underline;
        }
        #clientDetailsTable {
            margin-top: 20px;
            display: none;
        }
        #formFields {
            display: none; /* Ocultar campos inicialmente */
        }
        .delete-btn, .edit-btn {
            cursor: pointer;
            color: #007bff; /* Color azul para los iconos de editar y eliminar */
        }
        .delete-btn:hover, .edit-btn:hover {
            color: #0056b3; /* Azul más oscuro al hacer hover */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2>Gestión de Clientes</h2>
                <!-- Campo de búsqueda -->
                <input type="text" id="searchInput" class="form-control" placeholder="Buscar cliente...">
            </div>
            <div class="card-body">
                <!-- Mostrar lista de archivos y directorios en CLIENTS -->
                <h3>Contenido de la carpeta CLIENTS:</h3>
                {% if files %}
                    <ul id="clientList">
                        {% for file in files %}
                            <li class="client-item" onclick="openClientForm('{{ file }}')">{{ file }}</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>No se encontraron archivos en la carpeta CLIENTS.</p>
                {% endif %}
                {% if error %}
                    <p class="text-danger">{{ error }}</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal para el formulario de cliente -->
    <div class="modal fade" id="clientFormModal" tabindex="-1" role="dialog" aria-labelledby="clientFormModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="clientFormModalLabel">Detalles del Cliente</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Tabla para mostrar los datos guardados -->
                    <table class="table" id="clientDetailsTable">
                        <thead>
                            <tr>
                                <th scope="col">Sucursal</th>
                                <th scope="col">Branch</th>
                                <th scope="col">DMS</th>
                                <th scope="col">Reportes</th>
                                <th scope="col">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clientDetailsBody">
                            <!-- Se llenará dinámicamente con los datos del cliente -->
                        </tbody>
                    </table>

                    <!-- Botón para agregar registro -->
                    <button type="button" class="btn btn-secondary" id="addRecordBtn">Agregar Registro</button>

                    <!-- Campos del formulario que están ocultos inicialmente -->
                    <form id="clientForm" style="margin-top: 15px;">
                        <div id="formFields">
                            <input type="hidden" id="client_name" name="client_name">
                            <div class="form-group">
                                <label for="branch">Branch</label>
                                <input type="text" class="form-control" id="branch" name="branch">
                            </div>
                            <div class="form-group">
                                <label for="branch_name">Nombre de Sucursal</label>
                                <input type="text" class="form-control" id="branch_name" name="branch_name">
                            </div>
                            <div class="form-group">
                                <label for="dms">DMS</label>
                                <input type="text" class="form-control" id="dms" name="dms">
                            </div>
                            <div class="form-group">
                                <label for="reports">Nombre de los Reportes a Utilizar</label>
                                <input type="text" class="form-control" id="reports" name="reports" placeholder="Separar por comas">
                            </div>
                            <button type="button" class="btn btn-secondary" id="addToTableBtn">Añadir a la Tabla</button>
                        </div>
                        <button type="button" class="btn btn-primary" id="saveDataBtn" style="margin-top: 15px;">Guardar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Incluye jQuery, Popper.js y Bootstrap JS desde un CDN -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Incluye Font Awesome JS desde un CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
    <!-- Incluye SweetAlert2 desde un CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Función para filtrar los resultados de la lista de clientes
        document.getElementById('searchInput').addEventListener('keyup', function() {
            var input, filter, ul, li, i, txtValue;
            input = document.getElementById('searchInput');
            filter = input.value.toUpperCase();
            ul = document.getElementById("clientList");
            li = ul.getElementsByTagName('li');

            for (i = 0; i < li.length; i++) {
                txtValue = li[i].textContent || li[i].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    li[i].style.display = "";
                } else {
                    li[i].style.display = "none";
                }
            }
        });

        // Función para abrir el formulario del cliente en un modal y cargar los datos existentes
        function openClientForm(clientName) {
            // Actualizar el título del modal con el nombre del cliente
            document.getElementById('clientFormModalLabel').innerText = `Detalles del Cliente: ${clientName}`;
            // Asignar el nombre del cliente al campo oculto
            document.getElementById('client_name').value = clientName;
            // Limpiar los campos del formulario (puedes personalizar según tus necesidades)
            document.getElementById('clientForm').reset();
            // Ocultar la tabla de detalles hasta que se carguen los datos
            document.getElementById('clientDetailsTable').style.display = 'none';
            // Limpiar la tabla de detalles del cliente
            document.getElementById('clientDetailsBody').innerHTML = '';
            // Ocultar los campos del formulario hasta que se presione "Agregar Registro"
            document.getElementById('formFields').style.display = 'none';

            // Cargar datos existentes para el cliente
            fetch(`/cliente_detalles/${clientName}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        const clientData = data.data;
                        const tableBody = document.getElementById('clientDetailsBody');

                        // Crear una fila con los datos del cliente
                        const registros = clientData.registros || [];
                        registros.forEach(registro => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${registro.branch_name || ''}</td>
                                <td>${registro.branch || ''}</td>
                                <td>${registro.dms || ''}</td>
                                <td>${Array.isArray(registro.reports) ? registro.reports.join(', ') : registro.reports || ''}</td>
                                <td>
                                    <button type="button" class="btn btn-link p-0 edit-btn">
                                        <i class="fa-solid fa-pen-to-square"></i>
                                    </button>
                                    <button type="button" class="btn btn-link p-0 delete-btn">
                                        <i class="fa-solid fa-trash-can"></i>
                                    </button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });

                        document.getElementById('clientDetailsTable').style.display = 'table';

                        // Añadir eventos de click a los botones de eliminación y edición
                        addDeleteEventListeners();
                        addEditEventListeners();
                    }
                })
                .catch(error => {
                    console.error('Error al cargar los detalles del cliente:', error);
                });

            // Abrir el modal
            $('#clientFormModal').modal('show');
        }

        // Función para añadir los eventos de eliminación a cada botón
        function addDeleteEventListeners() {
            const deleteButtons = document.querySelectorAll('.delete-btn');
            deleteButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const row = this.closest('tr');
                    const branch = row.cells[1].innerText;
                    const clientName = document.getElementById('client_name').value;

                    Swal.fire({
                        title: '¿Estás seguro?',
                        text: "No podrás revertir esto!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Sí, eliminarlo!',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Enviar solicitud al servidor para eliminar el registro del archivo config.json
                            fetch(`/eliminar_registro`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    client_name: clientName,
                                    branch: branch
                                })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // Eliminar la fila de la tabla
                                    row.remove();
                                    Swal.fire(
                                        'Eliminado!',
                                        'El registro ha sido eliminado.',
                                        'success'
                                    );
                                } else {
                                    Swal.fire(
                                        'Error!',
                                        data.error || 'Hubo un problema al eliminar el registro.',
                                        'error'
                                    );
                                }
                            })
                            .catch(error => {
                                console.error('Error al eliminar el registro:', error);
                                Swal.fire(
                                    'Error!',
                                    'Hubo un problema al eliminar el registro.',
                                    'error'
                                );
                            });
                        }
                    });
                });
            });
        }

        // Función para añadir los eventos de edición a cada botón
        function addEditEventListeners() {
            const editButtons = document.querySelectorAll('.edit-btn');
            editButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const row = this.closest('tr');
                    const branchNameCell = row.cells[0];
                    const branchCell = row.cells[1];
                    const dmsCell = row.cells[2];
                    const reportsCell = row.cells[3];

                    // Convertir las celdas en inputs para permitir la edición
                    branchNameCell.innerHTML = `<input type="text" class="form-control" value="${branchNameCell.innerText}">`;
                    branchCell.innerHTML = `<input type="text" class="form-control" value="${branchCell.innerText}">`;
                    dmsCell.innerHTML = `<input type="text" class="form-control" value="${dmsCell.innerText}">`;
                    reportsCell.innerHTML = `<input type="text" class="form-control" value="${reportsCell.innerText}">`;

                    // Cambiar el ícono de editar por el de guardar
                    this.innerHTML = `<i class="fa-solid fa-floppy-disk"></i>`;
                    this.classList.remove('edit-btn');
                    this.classList.add('save-btn');

                    // Añadir el evento de guardado
                    addSaveEventListeners();
                });
            });
        }

        // Función para añadir los eventos de guardado a cada botón
        function addSaveEventListeners() {
            const saveButtons = document.querySelectorAll('.save-btn');
            saveButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const row = this.closest('tr');

                    // Captura los valores antes de cualquier manipulación
                    const branchNameValue = row.cells[0].querySelector('input').value.trim();
                    const branchValue = row.cells[1].querySelector('input').value.trim();
                    const dmsValue = row.cells[2].querySelector('input').value.trim();
                    const reportsValue = row.cells[3].querySelector('input').value.trim();

                    // Asegurarse de que los inputs no estén vacíos antes de guardar
                    if (!branchNameValue || !branchValue || !dmsValue || !reportsValue) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Campos incompletos',
                            text: 'Por favor, complete todos los campos antes de guardar.'
                        });
                        return;
                    }

                    // Guardar los nuevos valores en las celdas
                    row.cells[0].innerText = branchNameValue;
                    row.cells[1].innerText = branchValue;
                    row.cells[2].innerText = dmsValue;
                    row.cells[3].innerText = reportsValue;

                    // Cambiar el ícono de guardar por el de editar
                    this.innerHTML = `<i class="fa-solid fa-pen-to-square"></i>`;
                    this.classList.remove('save-btn');
                    this.classList.add('edit-btn');

                    // Reasociar el evento de edición
                    addEditEventListeners();
                });
            });
        }


        // Función para mostrar los campos del formulario al presionar "Agregar Registro"
        document.getElementById('addRecordBtn').addEventListener('click', function() {
            document.getElementById('formFields').style.display = 'block';
        });

        // Función para añadir el registro a la tabla desde el formulario
        document.getElementById('addToTableBtn').addEventListener('click', function() {
            const branchName = document.getElementById('branch_name').value;
            const branch = document.getElementById('branch').value;
            const dms = document.getElementById('dms').value;
            const reports = document.getElementById('reports').value;

            if (!branchName || !branch || !dms || !reports) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Campos incompletos',
                    text: 'Por favor, complete todos los campos antes de agregar.'
                });
                return;
            }

            // Verificar que el branch no se repita
            const tableBody = document.getElementById('clientDetailsBody');
            let isDuplicate = false;
            for (let i = 0; i < tableBody.rows.length; i++) {
                const existingBranch = tableBody.rows[i].cells[1].innerText;
                if (existingBranch === branch) {
                    isDuplicate = true;
                    break;
                }
            }

            if (isDuplicate) {
                Swal.fire({
                    icon: 'error',
                    title: 'Branch duplicado',
                    text: 'El número de Branch ya existe en la tabla. Por favor, ingrese un número de Branch diferente.'
                });
                return;
            }

            // Si no se repite, agregar el registro a la tabla
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${branchName}</td>
                <td>${branch}</td>
                <td>${dms}</td>
                <td>${reports}</td>
                <td>
                    <button type="button" class="btn btn-link p-0 edit-btn">
                        <i class="fa-solid fa-pen-to-square"></i>
                    </button>
                    <button type="button" class="btn btn-link p-0 delete-btn">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
            document.getElementById('clientDetailsTable').style.display = 'table';

            // Añadir eventos de eliminación y edición al nuevo botón
            addDeleteEventListeners();
            addEditEventListeners();

            // Limpiar los campos del formulario después de agregar el registro
            document.getElementById('clientForm').reset();
            // Ocultar los campos nuevamente
            document.getElementById('formFields').style.display = 'none';
        });

        // Función para guardar los datos de la tabla en config.json
        document.getElementById('saveDataBtn').addEventListener('click', function() {
            const clientName = document.getElementById('client_name').value;

            if (!clientName) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'El nombre del cliente no está definido.'
                });
                return;
            }

            const tableBody = document.getElementById('clientDetailsBody');
            const registros = [];

            // Recorre cada fila de la tabla y toma los datos
            for (let i = 0; i < tableBody.rows.length; i++) {
                const cells = tableBody.rows[i].cells;
                const registro = {
                    branch_name: cells[0].innerText,
                    branch: cells[1].innerText,
                    dms: cells[2].innerText,
                    reports: cells[3].innerText.split(', ')
                };
                registros.push(registro);
            }

            // Enviar los datos al servidor para guardar
            fetch('/guardar_cliente', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    client_name: clientName,
                    registros: registros
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Éxito',
                        text: 'Datos guardados con éxito'
                    }).then(() => {
                        $('#clientFormModal').modal('hide');
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Error al guardar los datos: ' + data.error
                    });
                }
            })
            .catch(error => {
                console.error('Error al guardar los datos:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error al guardar los datos'
                });
            });
        });

        // Llamar a las funciones de asociación de eventos al cargar la página
        addDeleteEventListeners();
        addEditEventListeners();
    </script>
</body>
</html>
