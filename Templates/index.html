<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuración de Parámetros</title>
    <!-- Incluye Bootstrap CSS desde un CDN -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Incluye SweetAlert2 CSS desde un CDN -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <!-- Incluye Font Awesome 6 desde un CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        .container {
            margin-top: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .trash-btn {
            background: #dc3545;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            display: flex;
            align-items: center;
            padding: 5px 10px;
        }
        .trash-btn:hover {
            background: #c82333;
        }
        .trash-btn i {
            margin-right: 5px;
        }
        .btn-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        .btn-left-container {
            display: flex;
            gap: 10px;
        }
        .card-header h5 {
            margin-bottom: 0;
        }
        /* Estilo para ocultar el campo de reportes */
        #reportes-field {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card mb-4 shadow-lg p-3 mb-5 bg-body-tertiary rounded">
            <div class="card-header">
                <h2>Configuración de Parámetros</h2>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="form-group">
                        <label for="workng_dir">Directorio de Trabajo:</label>
                        <input type="text" id="workng_dir" name="workng_dir" class="form-control" value="{{ config.get('workng_dir', '') }}">
                    </div>
                    <div class="form-group">
                        <label for="sandbx">Directorio de Sandbox:</label>
                        <input type="text" id="sandbx" name="sandbx" class="form-control" value="{{ config.get('sandbx', '') }}">
                    </div>
                    <!-- Campo de reportes oculto -->
                    <div id="reportes-field">
                        <div class="form-group">
                            <label for="reportes">Reportes (separados por comas):</label>
                            <input type="text" id="reportes" name="reportes" class="form-control" value="{{ ', '.join(config.get('reportes', [])) }}">
                        </div>
                    </div>
                    <div id="reportes-container">
                        {% for key, columnas in config.get('columnas_esperadas', {}).items() %}
                        <div class="form-group d-flex align-items-center">
                            <label for="columnas_{{ key }}" class="mr-2">{{ key }} Columnas:</label>
                            <input type="text" id="columnas_{{ key }}" name="columnas_{{ key }}" class="form-control mr-2" value="{{ ', '.join(columnas) }}">
                            <button type="button" class="trash-btn" data-reporte="{{ key }}" onclick="eliminarReporte('{{ key }}')">
                                <i class="fa fa-trash-alt"></i> Eliminar
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="btn-container">
                        <div class="btn-left-container">
                            <button type="button" id="add-reporte-btn" class="btn btn-success" data-toggle="modal" data-target="#addReportModal">
                                <i class="fa-regular fa-file-lines"></i> Agregar Reporte
                            </button>
                            <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#dbConfigModal">
                                <i class="fa-solid fa-database"></i> Configuración bd
                            </button>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fa-solid fa-floppy-disk"></i> Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para agregar nuevos reportes -->
    <div class="modal fade" id="addReportModal" tabindex="-1" role="dialog" aria-labelledby="addReportModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title" id="addReportModalLabel">Agregar Nuevo Reporte</h5>
                    </div>
                    <div class="card-body">
                        <form id="addReportForm">
                            <div class="form-group">
                                <label for="nuevo_reporte_nombre">Nombre del nuevo reporte:</label>
                                <input type="text" id="nuevo_reporte_nombre" name="nombre" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="nuevo_reporte_columnas">Columnas (Separadas por comas):</label>
                                <input type="text" id="nuevo_reporte_columnas" name="columnas" class="form-control">
                            </div>
                            <button type="button" id="save-report-btn" class="btn btn-primary">Guardar Reporte</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para la configuración de la base de datos -->
    <div class="modal fade" id="dbConfigModal" tabindex="-1" role="dialog" aria-labelledby="dbConfigModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title" id="dbConfigModalLabel">Configuración de la Base de Datos</h5>
                    </div>
                    <div class="card-body">
                        <form id="dbConfigForm" method="POST">
                            <div class="form-group">
                                <label for="db_host">Host DB:</label>
                                <input type="text" id="db_host" name="db_host" class="form-control" value="{{ config.get('db', {}).get('host', '') }}">
                            </div>
                            <div class="form-group">
                                <label for="db_usuario">Usuario DB:</label>
                                <input type="text" id="db_usuario" name="db_usuario" class="form-control" value="{{ config.get('db', {}).get('usuario', '') }}">
                            </div>
                            <div class="form-group">
                                <label for="db_contrasena">Contraseña DB:</label>
                                <input type="password" id="db_contrasena" name="db_contrasena" class="form-control" value="{{ config.get('db', {}).get('contrasena', '') }}">
                            </div>
                            <div class="form-group">
                                <label for="db_base_datos">Base de Datos DB:</label>
                                <input type="text" id="db_base_datos" name="db_base_datos" class="form-control" value="{{ config.get('db', {}).get('base_de_datos', '') }}">
                            </div>
                            <button type="button" id="save-db-config-btn" class="btn btn-primary">Guardar Configuración DB</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Incluye Bootstrap JS y dependencias desde un CDN -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <script>
        function eliminarReporte(reporte) {
            Swal.fire({
                title: 'Confirmar',
                text: "¿Estás seguro de que deseas eliminar este reporte?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/delete-reporte', {
                        method: 'POST',
                        body: new URLSearchParams({
                            reporte: reporte
                        }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.querySelector(`button[data-reporte="${reporte}"]`).closest('.form-group').remove();
                            Swal.fire('Eliminado', 'El reporte ha sido eliminado.', 'success')
                            .then(() => {
                                location.reload(); // Recargar la página después de eliminar
                            });
                        } else {
                            Swal.fire('Error', data.error, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Error', 'No se pudo eliminar el reporte', 'error');
                    });
                }
            });
        }

        // Añadir nuevos reportes
        document.getElementById('save-report-btn').addEventListener('click', function() {
            var form = document.getElementById('addReportForm');
            fetch('/add-reporte', {
                method: 'POST',
                body: new URLSearchParams(new FormData(form)),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Éxito', 'Reporte agregado correctamente', 'success')
                    .then(() => {
                        location.reload(); // Recargar la página para mostrar el nuevo reporte
                    });
                } else {
                    Swal.fire('Error', data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'No se pudo agregar el reporte', 'error');
            });
        });

        // Manejo del formulario de configuración
        document.querySelector('form').addEventListener('submit', function(event) {
            event.preventDefault();
            var form = event.target;
            fetch('/', {
                method: 'POST',
                body: new URLSearchParams(new FormData(form)),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Éxito', 'Configuración guardada correctamente', 'success');
                } else {
                    Swal.fire('Error', data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'No se pudo guardar la configuración', 'error');
            });
        });

        // Manejo del formulario de configuración de DB
        document.getElementById('save-db-config-btn').addEventListener('click', function() {
            var form = document.getElementById('dbConfigForm');
            fetch('/save-db-config', {
                method: 'POST',
                body: new URLSearchParams(new FormData(form)),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Éxito', 'Configuración de base de datos guardada correctamente', 'success')
                    .then(() => {
                        location.href = '/'; // Redirigir al menú principal
                    });
                } else {
                    Swal.fire('Error', data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'No se pudo guardar la configuración de la base de datos', 'error');
            });
        });
    </script>
</body>
</html>
