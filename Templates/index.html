<!DOCTYPE html>
<html lang="es">
<head>
    {% extends "layout.html" %}
    {% block content %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuración de Parámetros</title>
    <!-- Incluye Bootstrap CSS desde un CDN -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Incluye SweetAlert2 CSS desde un CDN -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <!-- Incluye Font Awesome 6 desde un CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            color: #ffffff;
        }
        .sidebar {
            height: 100vh;
            width: 50px;
            position: fixed;
            top: 0;
            left: 0;
            background-color: #333;
            color: #fff;
            overflow-x: hidden;
            transition: width 0.3s, transform 0.3s;
            padding-top: 20px;
            z-index: 1;
            display: flex;
            flex-direction: column;
        }
        .sidebar.expanded {
            width: 250px;
        }
        .sidebar a {
            padding: 15px 20px;
            text-decoration: none;
            font-size: 18px;
            color: #fff;
            display: block;
            transition: background-color 0.3s;
        }
        .sidebar a:hover {
            background-color: #575757;
        }
        .sidebar .togglebtn {
            font-size: 20px;
            cursor: pointer;
            margin-top: auto;
            margin-bottom: 15px;
            text-align: center;
            padding: 10px;
            background-color: #333;
            color: #fff;
            border: none;
            width: 100%;
        }
        .content {
            margin-left: 50px;
            padding: 20px;
            transition: margin-left 0.3s, overflow 0.3s;
        }
        .sidebar.expanded ~ .content {
            margin-left: 250px;
        }
        .container {
            margin-top: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            padding: 20px;
        }
        .card {
            background-color: #f8f9fa;
        }
        .card-header {
            background-color: #e9ecef;
        }
        .card-body {
            background-color: #f1f3f5;
            border-radius: 8px;
            padding: 20px;
        }
        .card-header h2, .card-header h5, .form-group label {
            color: #000000;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .trash-btn, .edit-btn {
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            display: flex;
            align-items: center;
            padding: 5px 10px;
        }
        .trash-btn {
            background: #dc3545;
        }
        .trash-btn:hover {
            background: #c82333;
        }
        .trash-btn i, .edit-btn i {
            margin-right: 5px;
        }
        .edit-btn {
            background: #ffc107;
        }
        .edit-btn:hover {
            background: #e0a800;
        }
        .btn-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        .btn-left-container {
            display: flex;
            gap: 10px;
        }
        .card-header h5 {
            margin-bottom: 0;
        }
        .tab-pane .form-group:first-of-type {
            margin-top: 1cm;
        }
        .nav-tabs .nav-link {
            background-color: #ffffff;
            color: #000000;
        }
        .nav-tabs .nav-link.active {
            background-color: #ffffff;
            color: #000000;
        }
        .tab-content {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 20px;
        }
        .sidebar .menu-text {
            display: none;
        }
        .sidebar.expanded .menu-text {
            display: inline;
            margin-left: 10px;
        }
        .menu-image {
            width: 100%;
            height: auto;
            padding: 10px 0;
            display: block;
        }
        .sidebar.expanded .menu-image {
            display: block;
        }
        .sidebar:not(.expanded) .menu-image {
            display: none;
        }
        /* Cambiar el color del texto en los modales a negro */
        .modal-content {
            color: #000000; /* Texto en color negro */
        }

        /* Asegurar que el texto dentro de la lista y los campos de texto también sean negros */
        .modal-content .list-group-item,
        .modal-content textarea,
        .modal-content h5 {
            color: #000000; /* Texto en color negro */
        }

        /* Asegurar que los botones no se desplacen y que el texto largo no los afecte */
        .table td {
            vertical-align: middle;
            white-space: nowrap; /* Evita que el texto se envuelva */
        }

        .d-flex {
            display: flex;
            justify-content: space-between;
            align-items: center;
            white-space: nowrap;
        }

        .formula-text {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px; /* Ajusta el ancho máximo según sea necesario */
            display: inline-block;
            vertical-align: middle;
        }

        .table td button {
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .table td span {
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px; /* Ajusta el ancho máximo según sea necesario */
            display: inline-block;
            vertical-align: middle;
        }
        .table td .btn {
            white-space: nowrap;
        }

        .table td .btn-group {
            display: flex;
            gap: 5px;
        }

        .table td .btn-group .btn {
            flex: 1;
        }

        .table td:nth-child(2) {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px; /* Ajusta el ancho máximo según sea necesario */
        }

        .modal-body {
            max-height: 70vh; /* Limita la altura máxima del cuerpo del modal */
            overflow-y: auto; /* Agrega desplazamiento vertical si es necesario */
        }

        .table-responsive {
            display: block;
            width: 100%;
            overflow-x: auto; /* Agrega desplazamiento horizontal si es necesario */
            -webkit-overflow-scrolling: touch; /* Permite desplazamiento suave en dispositivos táctiles */
        }

        .function-list, .operator-list {
            max-height: 100px; /* Limitar la altura para hacer espacio para el scroll */
            overflow-y: auto;
            margin-top: 10px;
        }

        .function-list ul, .operator-list ul {
            padding-left: 0;
        }

        .function-list li, .operator-list li {
            cursor: pointer;
            list-style-type: none;
            padding: 5px;
            margin: 2px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f8f9fa;
        }

        .function-list li:hover, .operator-list li:hover {
            background-color: #e9ecef;
        }
        .list-group-item:hover {
            background-color: #f0f0f0;
            cursor: pointer;
        }
        body {
            color: #000000; /* Establece el color del texto en negro */
        }
        .sidebar a, .sidebar .togglebtn {
            color: #ffffff; /* El color del texto de la barra lateral se mantiene en blanco */
        }
        .card-header, .card-body, .nav-link, .modal-content {
            color: #000000; /* Establece el color del texto en las tarjetas, pestañas y modales en negro */
        }
        /* Asegurar que cualquier otro texto en el cuerpo del contenido también sea negro */
        .content, .container, h2, h3, p, ul, li {
            color: #000000;
        }
        .sortable-ghost {
            opacity: 0.5;
            background-color: #e9ecef;
        }
        /* Estilo para el contenedor del buscador con lupa */
        .search-container {
            max-width: 300px; /* Limita el ancho del campo de búsqueda */
            border-radius: 25px; /* Hace que los bordes sean redondeados */
            overflow: hidden; /* Asegura que los elementos hijos sigan la forma redondeada */
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); /* Añade una sombra suave */
        }

        /* Estilo del campo de búsqueda */
        .search-input {
            border: none;
            padding: 0.5rem 1rem; /* Espacio interno para el texto */
            font-size: 1rem; /* Ajusta el tamaño de la fuente */
        }

        /* Estilo para el icono de lupa */
        .input-group-text {
            background-color: #fff; /* Fondo blanco para la lupa */
            border: none; /* Eliminar bordes */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem; /* Espacio alrededor de la lupa */
        }

        /* Botón de agregar reporte */
        .btn-success {
            font-size: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            display: flex;
            align-items: center;
        }

        /* Espacio de separación entre el título y los reportes */
        .mt-4 {
            margin-top: 2rem; /* Añade espacio encima del listado de reportes */
        }

        /* Título de reportes con márgenes ajustados */
        h3.mb-0 {
            margin-bottom: 0.5rem; /* Un pequeño margen debajo del título */
            font-weight: bold; /* Hace el texto del título un poco más destacado */
        }

        #formula-text {
            border: 1px solid #ced4da;
            padding: 10px;
            border-radius: 5px;
            min-height: 50px;
            white-space: pre-wrap; /* Para respetar los espacios y saltos de línea */
            word-wrap: break-word; /* Para que las palabras largas se dividan al final de la línea */
        }
        .column-list {
            display: flex;
            flex-direction: column;
            gap: 10px; /* Espacio entre las filas */
        }

        .column-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
            width: 100%; /* Asegurar que el ancho ocupe todo el contenedor */
        }

        .column-item span {
            flex-grow: 1; /* El texto de la columna se expande para usar todo el espacio */
            margin-right: 10px; /* Espacio entre el texto y los botones */
            white-space: nowrap; /* Evita que el texto se divida en varias líneas */
        }

        .computed {
            background-color: #c1ea8c; /* Pintar en verde las columnas calculadas */
        }

        .column-item .btn-group {
            display: flex;
            gap: 5px; /* Espacio entre los botones */
        }

        .btn-group .btn {
            padding: 0.375rem 0.5rem; /* Tamaño de los botones */
        }
        .cursor-pointer {
            cursor: pointer; /* Cambia el cursor a "manita" */
        }

        /* Clase para las columnas computed */
        .column-item.bg-success {
            background-color: #12cf51 !important;  /* Verde para las columnas computed */
            color: white !important;  /* Texto en blanco */
        }

        .column-item i.fa {
            font-size: 16px;
            color: gray;
            margin-right: 5px;
            cursor: pointer;
        }

        .column-item i.fa-eye-slash {
            color: red;  /* O un color más discreto si lo prefieres */
        }

        .column-item i.fa-eye {
            color: rgb(79, 179, 79);  /* O un color más discreto si lo prefieres */
        }
        /* Clase para íconos visibles */
        .visible-icon {
            opacity: 1;
        }

        /* Clase para íconos deshabilitados o invisibles */
        .disabled-icon {
            opacity: 0.3;
        }
        #column-list {
            max-height: 300px; /* Ajusta la altura máxima a tu preferencia */
            overflow-y: auto;  /* Habilita el scroll vertical */
            padding: 5px;      /* Espacio interno opcional */
            border: 1px solid #ddd;  /* Borde opcional */
        }

        .function-list, .operator-list {
            max-height: 150px;  /* Puedes ajustar el valor según el diseño */
            overflow-y: auto;
        }

        #ace-editor {
            height: 400px;
            width: 100%;
        }
        #column-list-ace {
            max-height: 300px;  /* Ajusta esta altura a tu preferencia */
            overflow-y: auto;   /* Habilita el scroll vertical */
        }



    </style>
</head>
<body>
    <div class="sidebar" id="mySidebar">
        <br>
        <br>
        <a href="/home" class="menu-item">
            <i class="fa-solid fa-house-chimney"></i>
            <span class="menu-text"> Inicio</span> 
        </a>
        <a href="/" class="menu-item">
            <i class="fa-solid fa-gear"></i>
            <span class="menu-text"> Configuración</span>
        </a>
        <a href="/clientes" class="menu-item">
            <i class="fa-solid fa-folder-open"></i>
            <span class="menu-text"> Clientes</span> 
        </a>
        <a href="/database" class="menu-item">
            <i class="fa-solid fa-database"></i>
            <span class="menu-text"> Base de Datos</span> 
        </a>
        <span class="togglebtn" onclick="toggleNav()">
            <i class="fa-solid fa-angles-right"></i> 
        </span>
    </div>

    <div id="main">
        <div class="content">
            <div class="container">
                <div class="card mb-4 shadow-lg p-3 mb-5 bg-body-tertiary rounded">
                    <div class="card-header">
                        <h2>Configuración de Parámetros</h2>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="myTab" role="tablist">
                            {% for tab in tabs %}
                            <li class="nav-item">
                                <a class="nav-link {% if loop.first %}active{% endif %}" id="tab-{{ loop.index }}-tab" data-toggle="tab" href="#tab-{{ loop.index }}" role="tab" aria-controls="tab-{{ loop.index }}" aria-selected="{% if loop.first %}true{% else %}false{% endif %}">{{ tab }}</a>
                            </li>
                            {% endfor %}
                            <li class="nav-item">
                                <a class="nav-link" id="add-tab" href="#" role="tab" aria-selected="false" onclick="agregarPestaña()">
                                    <i class="fa-solid fa-plus"></i>
                                </a>
                            </li>
                        </ul>
                        <div class="tab-content" id="myTabContent">
                            {% for tab in tabs %}
                            <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="tab-{{ loop.index }}" role="tabpanel" aria-labelledby="tab-{{ loop.index }}-tab">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h3 class="mb-0">Reportes en {{ tab }}</h3>
                                    <div class="d-flex align-items-center">
                                        <!-- Buscador estilizado con lupa -->
                                        <div class="input-group search-container">
                                            <input type="text" class="form-control search-input" id="search-{{ loop.index }}" placeholder="Buscar reportes..." onkeyup="filtrarReportes('{{ tab }}', '{{ loop.index }}')">
                                            <div class="input-group-append">
                                                <span class="input-group-text"><i class="fa fa-search"></i></span>
                                            </div>
                                        </div>
                                        <!-- Botón de agregar reporte -->
                                        <button type="button" class="btn btn-success ml-3" data-toggle="modal" data-target="#addReportModal">
                                            <i class="fa fa-plus"></i> Agregar Reporte
                                        </button>
                                    </div>
                                </div>
                                <!-- Agrega un espacio de separación entre el título y la lista de reportes -->
                                <div class="mt-4">
                                    {% if tab_data[tab].reportes %}
                                    <ul class="list-group" id="reporte-list-{{ loop.index }}">
                                        {% for reporte in tab_data[tab].reportes %}
                                        {% set columnas = tab_data[tab].columnas_esperadas[reporte].columnas %}
                                        {% set data_types = tab_data[tab].columnas_esperadas[reporte].data_types %}
                                        {% set columnas_no_typed = [] %}
                                        {% for columna in columnas %}
                                            {% if columna not in data_types %}
                                                {% set _ = columnas_no_typed.append(columna) %}
                                            {% endif %}
                                        {% endfor %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center reporte-item">
                                            <div style="flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                <strong>{{ reporte }}</strong>
                                                {% if columnas_no_typed %}
                                                <i class="fa fa-triangle-exclamation text-warning"></i>
                                                {% endif %}
                                            </div>
                                            <div class="btn-group ml-auto" role="group" style="white-space: nowrap;">
                                                <!-- Botones de acciones -->
                                                <button class="btn btn-outline-warning" onclick="abrirEditarColumnasModal('{{ tab }}', '{{ reporte }}')">
                                                    <i class="fa fa-edit"></i> Editar
                                                </button>
                                                <button class="btn btn-outline-success" onclick="selectColumn('{{ tab }}', '{{ reporte }}')">
                                                    <i class="fa fa-calculator"></i> Función
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary" 
                                                        onclick="abrirModalConfiguracionColumnas('{{ tab }}', '{{ reporte }}')"
                                                        data-tab="{{ tab }}" 
                                                        data-reporte="{{ reporte }}">
                                                    <i class="fa fa-database"></i> Tipo de datos
                                                </button>
                                                <button class="btn btn-outline-info" onclick="duplicarReporte('{{ tab }}', '{{ reporte }}')">
                                                    <i class="fa fa-copy"></i> Duplicar
                                                </button>
                                                <button class="btn btn-outline-danger" onclick="eliminarReporte('{{ tab }}', '{{ reporte }}')">
                                                    <i class="fa fa-trash-alt"></i> Eliminar
                                                </button>
                                            </div>
                                        </li>
                                        {% endfor %}
                                    </ul>                                    
                                    {% else %}
                                    <p>No hay reportes guardados en esta pestaña.</p>
                                    {% endif %}
                                </div>
                            </div>                                                                                
                            {% endfor %}
                        </div>                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar una columna específica -->
    <div class="modal fade" id="editSpecificColumnModal" tabindex="-1" role="dialog" aria-labelledby="editSpecificColumnModalLabel" aria-hidden="true" style="z-index: 1060;">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editSpecificColumnModalLabel">Editar Columna</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="editColumnForm">
                        <div class="form-group">
                            <label for="edit_column_name">Nombre de la columna:</label>
                            <input type="text" id="edit_column_name" name="edit_column_name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <!-- Checkbox para Computed Field -->
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="computed_field_edit" name="computed_field_edit">
                                <label class="form-check-label" for="computed_field_edit">Computed Field</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="saveEditColumnBtn">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>



    <!-- Modal para editar una columna -->
    <div class="modal fade" id="editColumnModal" tabindex="-1" role="dialog" aria-labelledby="editColumnModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editColumnModalLabel">Editar Columna</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="column-edit-list" class="column-list">
                        <!-- Las columnas se cargarán aquí dinámicamente -->
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-between align-items-center">
                    <!-- Botón para agregar una nueva columna -->
                    <button type="button" class="btn btn-success" id="addNewColumnBtn">
                        <i class="fa fa-plus"></i> Agregar Nueva Columna
                    </button>
                    <div>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                        <button type="button" class="btn btn-primary" id="saveOrderBtn">Guardar Orden</button>
                    </div>
                </div>
            </div>
        </div>
    </div>




    <!-- Modal para agregar filtro -->
    <div class="modal fade" id="filterModal" tabindex="-1" role="dialog" aria-labelledby="filterModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="filterModalLabel">Agregar Filtro para Factura</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            </div>
            <div class="modal-body">
            <!-- Campo de texto donde el usuario puede ingresar la columna que desea filtrar -->
            <div class="form-group">
                <label for="filterColumn">Columna:</label>
                <input type="text" class="form-control" id="filterColumn" value="Factura" readonly>
            </div>
    
            <!-- Campo para seleccionar la condición (Ej: "No está vacío") -->
            <div class="form-group">
                <label for="condition">Condición:</label>
                <select id="condition" class="form-control">
                <option value="<>''">No está vacío</option>
                <option value="=">=</option>
                <option value="<>">No igual a</option>
                </select>
            </div>
    
            <!-- Campo de texto para ingresar el valor de comparación -->
            <div class="form-group">
                <label for="filterValue">Valor de comparación:</label>
                <input type="text" class="form-control" id="filterValue" placeholder="Ej: FACTURA">
            </div>
    
            <!-- Checkbox para incluir condición de 'Campo vacío' -->
            <div class="form-group">
                <input type="checkbox" id="includeEmptyField">
                <label for="includeEmptyField">Campo vacío</label>
            </div>
    
            <!-- Operación adicional para la función LEFT -->
            <div class="form-group">
                <input type="checkbox" id="useLeftFunction">
                <label for="useLeftFunction">Aplicar función Left (Especifique número de caracteres):</label>
                <input type="number" class="form-control" id="leftCharacters" min="1" value="7" disabled>
            </div>
            </div>
    
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            <button type="button" class="btn btn-primary" id="applyFilterBtn">Aplicar Filtro</button>
            </div>
        </div>
        </div>
    </div>
  



    <!-- Modal para agregar una nueva columna -->
    <div class="modal fade" id="addNewColumnModal" tabindex="-1" role="dialog" aria-labelledby="addNewColumnModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addNewColumnModalLabel">Agregar Nueva Columna</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addNewColumnForm">
                        <div class="form-group">
                            <label for="new_column_name">Nombre de la nueva columna:</label>
                            <input type="text" id="new_column_name" name="new_column_name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <!-- Agrega el checkbox para Computed Field -->
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="computed_field" name="computed_field">
                                <label class="form-check-label" for="computed_field">Computed Field</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="saveNewColumnBtn">Guardar Columna</button>
                </div>
            </div>
        </div>
    </div>



    <!-- Modal para seleccionar una columna -->
    <div class="modal fade" id="selectColumnModal" tabindex="-1" role="dialog" aria-labelledby="selectColumnModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="selectColumnModalLabel">Seleccionar Columna para la Fórmula</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <ul id="column-select-list" class="list-group">
                        <!-- Columnas sin fórmula se cargarán aquí -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    
    <!-- Modal para ver las columnas con fórmulas -->
    <div class="modal fade" id="viewFormulasModal" tabindex="-1" role="dialog" aria-labelledby="viewFormulasModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewFormulasModalLabel">Columnas con Fórmulas Existentes</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Columna</th>
                                <th>Fórmula</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="formulas-list">
                            <!-- Aquí se llenarán las columnas con fórmulas -->
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button id="addFunctionBtn" type="button" class="btn btn-primary">Añadir Función</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar una fórmula -->
    <div class="modal fade" id="functionModal" tabindex="-1" role="dialog" aria-labelledby="functionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="functionModalLabel">Crear Función</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body d-flex">
                    <div class="col-4">
                        <h6>Buscar en Columnas:</h6>
                        <input type="text" id="search-columns" class="form-control mb-3" placeholder="Buscar columna...">
                        <h6>Columnas Disponibles:</h6>
                        <ul id="column-list" class="list-group">
                            <!-- Las columnas se agregarán aquí dinámicamente -->
                        </ul>
                    </div>
                    <div class="col-8">
                        <h6>Fórmula para <span id="selected-column-name"></span>:</h6>
                        <!-- Div editable que permite contenido enriquecido -->
                        <textarea id="formula-text" class="form-control" rows="2"></textarea>
                        <!-- Botón con el ícono de Python -->
                        <button type="button" class="btn btn-outline-primary mt-2" id="openAceEditorBtn">
                            <i class="fa-brands fa-python"></i> Fórmulas Avanzadas
                        </button>                        
                        <h6 class="mt-4">Funciones de Excel:</h6>
                        <div class="function-list">
                            <ul id="excel-functions" class="list-group">
                                <!-- Las funciones de funcionesExternas.py se agregarán aquí dinámicamente -->
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="save-formula-btn">Guardar Fórmula</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para usar Ace Editor -->
    <div class="modal fade" id="aceEditorModal" tabindex="-1" role="dialog" aria-labelledby="aceEditorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aceEditorModalLabel">Editor de Fórmula Avanzada</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body d-flex">
                    <!-- Lista de columnas -->
                    <div class="col-4">
                        <h6>Buscar en Columnas:</h6>
                        <input type="text" id="search-columns-ace" class="form-control mb-3" placeholder="Buscar columna...">
                        <h6>Columnas Disponibles:</h6>
                        <ul id="column-list-ace" class="list-group"></ul>
                            <!-- Las columnas se agregarán aquí dinámicamente -->
                        </ul>
                        <input type="hidden" id="nombre-reporte" value="">
                        <input type="hidden" id="nombre-tab" value="">
                    </div>  
                    <!-- Ace Editor -->
                    <div class="col-8">
                        <div id="ace-editor" style="height: 400px; width: 100%;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="saveFormulaBtn">Guardar Fórmula</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal para agregar nuevos reportes -->
    <div class="modal fade" id="addReportModal" tabindex="-1" role="dialog" aria-labelledby="addReportModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title" id="addReportModalLabel">Agregar Nuevo Reporte</h5>
                    </div>
                    <div class="card-body">
                        <form id="addReportForm">
                            <div class="form-group">
                                <label for="nuevo_reporte_nombre">Nombre del nuevo reporte:</label>
                                <input type="text" id="nuevo_reporte_nombre" name="nombre" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="nuevo_reporte_columnas">Columnas (Separadas por comas):</label>
                                <input type="text" id="nuevo_reporte_columnas" name="columnas" class="form-control">
                            </div>
                            <input type="hidden" id="tab_name" name="tab_name" value=""> <!-- Para enviar el nombre de la pestaña -->
                            <button type="button" id="save-report-btn" class="btn btn-primary">Guardar Reporte</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="configureColumnsModal" tabindex="-1" role="dialog" aria-labelledby="configureColumnsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="configureColumnsModalLabel">Configurar Columnas del Reporte</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="configureColumnsForm">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Data Type</th>
                                    <th>Length/Precision</th>
                                </tr>
                            </thead>
                            <tbody id="configureColumnsTableBody">
                                <!-- Las filas se añadirán dinámicamente aquí -->
                            </tbody>
                        </table>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button id="adddata" class="btn btn-primary"><i class="fa-solid fa-floppy-disk"></i> Guardar</button>
                </div>                               
            </div>
        </div>
    </div>
    

    <!-- Incluye jQuery, Popper.js y Bootstrap JS desde un CDN -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Incluye Font Awesome JS desde un CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <!-- Incluir Sortable.js desde un CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
  

    <script>
        function toggleNav() {
            var sidebar = document.getElementById("mySidebar");
            var main = document.getElementById("main");
            var toggleBtn = document.querySelector('.togglebtn');
            
            if (sidebar.classList.contains("expanded")) {
                sidebar.classList.remove("expanded");
                main.style.marginLeft = '50px';
                main.style.overflow = 'auto';
                toggleBtn.innerHTML = '<i class="fa-solid fa-angles-right"></i>';
            } else {
                sidebar.classList.add("expanded");
                main.style.marginLeft = '250px';
                main.style.overflow = 'hidden';
                toggleBtn.innerHTML = '<i class="fa-solid fa-angles-left"></i> Ocultar Menú';
            }
        }

        function editarReporte(reporte) {
            window.location.href = `/edit_reporte/${reporte}`;
        }
        
        function abrirEditarColumnasModal(tabName, reporte) {
    fetch(`/edit_reporte/${reporte}?tab_name=${tabName}`)
        .then(response => response.json())
        .then(data => {
            const columnas = data.columnas || [];
            const columnList = document.getElementById('column-edit-list');
            columnList.innerHTML = '';

            let fIndex = 1;  // Índice para las columnas que no son computadas

            columnas.forEach((col) => {
                const div = document.createElement('div');
                div.className = 'column-item d-flex align-items-center justify-content-between';
                div.setAttribute('data-original-name', col);

                // Verificar si la columna es "computed"
                const isComputedField = col.endsWith('(computed)');
                const cleanColName = isComputedField ? col.replace(' (computed)', '') : col;

                // Nombre de la columna
                const colSpan = document.createElement('span');
                colSpan.textContent = cleanColName;
                colSpan.className = 'column-name';

                // Aplicar color verde si es computed
                if (isComputedField) {
                    div.classList.add('bg-success', 'text-white');  // Añadir color verde para columnas computed
                }

                // Si no es columna calculada, agregamos la "F" con el número de índice
                if (!isComputedField) {
                    const fCol = document.createElement('span');
                    fCol.className = 'f-column';
                    fCol.textContent = `F${fIndex}`;
                    fIndex++;
                    div.appendChild(fCol);
                }

                div.appendChild(colSpan);

                // Ya no se crea el ícono de visibilidad ni el botón
                // Puedes eliminar todo el bloque relacionado con visibilityIcon y visibilityButton
                
                // Añadir botones de filtro, editar y eliminar
                const btnGroup = document.createElement('div');
                btnGroup.className = 'btn-group ml-auto';

                const filterBtn = document.createElement('button');
                filterBtn.className = 'btn btn-primary btn-sm';
                filterBtn.innerHTML = '<i class="fa-solid fa-filter"></i>';
                
                filterBtn.addEventListener('click', function () {
                    abrirFiltroModal(col);
                });

                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-warning btn-sm';
                editBtn.innerHTML = '<i class="fa fa-edit"></i>';
                
                editBtn.addEventListener('click', function () {
                    abrirModalEditarColumna(tabName, reporte, col);
                });

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-sm';
                deleteBtn.innerHTML = '<i class="fa fa-trash-alt"></i>';
                deleteBtn.addEventListener('click', function () {
                    eliminarColumna(tabName, reporte, col);
                });

                btnGroup.appendChild(filterBtn);
                btnGroup.appendChild(editBtn);
                btnGroup.appendChild(deleteBtn);
                div.appendChild(btnGroup);

                columnList.appendChild(div);
            });

            // Inicializamos la funcionalidad de arrastrar y soltar
            new Sortable(columnList, {
                animation: 150,
                handle: '.column-item',
                ghostClass: 'sortable-ghost',
                onEnd: function () {
                    actualizarFColumn();  // Actualizar la columna F después del reordenamiento
                }
            });

            document.getElementById('editColumnModal').setAttribute('data-tab', tabName);
            document.getElementById('editColumnModal').setAttribute('data-reporte', reporte);

            $('#editColumnModal').modal('show');
        })
        .catch(error => {
            console.error('Error al cargar las columnas:', error);
            Swal.fire('Error', 'No se pudieron cargar las columnas disponibles', 'error');
        });
}


// Función para actualizar los índices F después del reordenamiento
function actualizarFColumn() {
    let fIndex = 1;  // Reiniciar el índice

    // Seleccionar todas las columnas que no sean computadas
    document.querySelectorAll('#column-edit-list .column-item').forEach(function(columnItem) {
        const originalName = columnItem.getAttribute('data-original-name');

        if (!originalName.endsWith('(computed)')) {
            const fCol = columnItem.querySelector('.f-column');
            if (fCol) {
                fCol.textContent = `F${fIndex}`;  // Actualizar el valor de "F"
                fIndex++;  // Incrementar el índice para la siguiente columna no calculada
            }
        }
    });
}

// Función para alternar la visibilidad de una columna usando clases CSS
function toggleVisibility(icon) {
    if (icon.classList.contains('visible-icon')) {
        console.log("Cambiando a no visible (opacidad reducida)");
        icon.classList.remove('visible-icon');
        icon.classList.add('disabled-icon');
    } else {
        console.log("Cambiando a visible (opacidad normal)");
        icon.classList.remove('disabled-icon');
        icon.classList.add('visible-icon');
    }
}




function abrirFiltroModal(columna) {
    document.getElementById('filter-column-name').textContent = columna;  // Actualiza el nombre de la columna en el modal
    $('#addFilterModal').modal('show');  // Muestra el modal de filtro
}



function abrirModalEditarColumna(tab, reporte, columna) {
    // Establecer los atributos del modal
    document.getElementById('editSpecificColumnModal').setAttribute('data-tab', tab);
    document.getElementById('editSpecificColumnModal').setAttribute('data-reporte', reporte);
    document.getElementById('editSpecificColumnModal').setAttribute('data-original-column', columna);

    // Verificar si la columna es un campo computado y ocultar "(computed)"
    const isComputedField = columna.endsWith('(computed)');
    const computedFieldCheckbox = document.getElementById('computed_field_edit');

    if (isComputedField) {
        // Remover "(computed)" del nombre para mostrarlo en el modal
        document.getElementById('edit_column_name').value = columna.replace(' (computed)', '');
        computedFieldCheckbox.checked = true;
    } else {
        document.getElementById('edit_column_name').value = columna;
        computedFieldCheckbox.checked = false;
    }

    // Mostrar el modal de edición de columna específica
    $('#editSpecificColumnModal').modal('show');
}


document.getElementById('saveOrderBtn').addEventListener('click', function() {
    console.log("Botón clic SaveOrder presionado");

    const columnItems = document.querySelectorAll('.column-item');
    let columnas = [];  // Almacena las columnas en el formato correcto para el JSON

    // Verifica si hay columnas antes de proceder
    if (!columnItems || columnItems.length === 0) {
        Swal.fire('Error', 'No hay columnas para guardar.', 'error');
        return;
    }

    columnItems.forEach(item => {
        const originalName = item.getAttribute('data-original-name');  // Nombre original de la columna
        if (originalName) {
            columnas.push(originalName);  // Solo incluimos el nombre, sin el índice "F"
        }
    });

    const tabName = document.getElementById('editColumnModal').getAttribute('data-tab');
    const reporte = document.getElementById('editColumnModal').getAttribute('data-reporte');

    // Verifica si el tabName o el reporte son null o están vacíos
    if (!tabName || !reporte) {
        Swal.fire('Error', 'El nombre de la pestaña y el reporte son necesarios', 'error');
        return;
    }

    // Verifica si se ha ordenado correctamente alguna columna
    if (columnas.length === 0) {
        Swal.fire('Error', 'No se encontraron columnas válidas para guardar el orden.', 'error');
        return;
    }

    // Estructura del JSON que se enviará al servidor
    const jsonData = {
        name: tabName,
        reportes: [reporte],
        columnas_esperadas: {
            [reporte]: {
                columnas: columnas,  // Lista de columnas sin el prefijo "F"
                formulas: {},  // Puedes añadir las fórmulas aquí si es necesario
                data_types: {}  // Puedes añadir los tipos de datos aquí si es necesario
            }
        }
    };

    console.log("Datos a enviar al servidor:", jsonData); // Debug: Verificación del JSON antes de enviar

    // Enviar el nuevo orden al servidor
    fetch('/guardar-orden-columnas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(jsonData)  // Convertir el objeto a JSON antes de enviarlo
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire('Éxito', 'Orden de columnas guardado correctamente', 'success')
                .then(() => {
                    $('#editColumnModal').modal('hide');
                    abrirEditarColumnasModal(tabName, reporte);  // Recargar el modal para reflejar los cambios
                });
        } else {
            Swal.fire('Error', data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'No se pudo guardar el orden de las columnas', 'error');
    });
});





function editarColumna(tab, reporte, columna) {
    // Establecer los atributos del modal
    document.getElementById('editSpecificColumnModal').setAttribute('data-tab', tab);
    document.getElementById('editSpecificColumnModal').setAttribute('data-reporte', reporte);
    document.getElementById('editSpecificColumnModal').setAttribute('data-original-column', columna);

    // Verificar si la columna es un campo calculado
    const isComputedField = columna.endsWith('(computed)');
    const computedFieldCheckbox = document.getElementById('computed_field_edit');

    if (isComputedField) {
        // Remover "(computed)" del nombre de la columna para mostrarlo sin el sufijo
        document.getElementById('edit_column_name').value = columna.replace(' (computed)', '');
        // Marcar la casilla "Computed Field" y deshabilitarla
        computedFieldCheckbox.checked = true;
        computedFieldCheckbox.disabled = true;
    } else {
        document.getElementById('edit_column_name').value = columna;
        // Desmarcar la casilla "Computed Field" y deshabilitarla
        computedFieldCheckbox.checked = false;
        computedFieldCheckbox.disabled = true;
    }

    // Mostrar el modal de edición de columna específica
    $('#editSpecificColumnModal').modal('show');
}




document.getElementById('saveEditColumnBtn').addEventListener('click', function() {
    const newColumnName = document.getElementById('edit_column_name').value.trim();
    const isComputedField = document.getElementById('computed_field_edit').checked; // Verificar si el checkbox está marcado
    const tabName = document.getElementById('editSpecificColumnModal').getAttribute('data-tab');
    const reporte = document.getElementById('editSpecificColumnModal').getAttribute('data-reporte');
    const originalColumnName = document.getElementById('editSpecificColumnModal').getAttribute('data-original-column');

    // Si es un campo computado, añadimos "(computed)" al nombre
    const finalColumnName = isComputedField ? `${newColumnName} (computed)` : newColumnName;

    // Enviar el cambio al servidor
    fetch('/editar-columna', {
        method: 'POST',
        body: new URLSearchParams({
            tab_name: tabName,
            reporte: reporte,
            columna: originalColumnName,
            nueva_columna: finalColumnName  // Guardar el nombre completo con "(computed)" si aplica
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire('Éxito', 'Columna editada correctamente', 'success')
            .then(() => {
                $('#editSpecificColumnModal').modal('hide');
                abrirEditarColumnasModal(tabName, reporte);  // Recargar el modal para reflejar los cambios
            });
        } else {
            Swal.fire('Error', data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'No se pudo editar la columna', 'error');
    });
});


function eliminarColumna(tab, reporte, columna) {
    Swal.fire({
        title: 'Confirmar',
        text: `¿Estás seguro de que deseas eliminar la columna "${columna}"?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch('/eliminar-columna', {
                method: 'POST',
                body: new URLSearchParams({
                    tab_name: tab,
                    reporte: reporte,
                    columna: columna
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Eliminado', 'La columna ha sido eliminada.', 'success')
                    .then(() => {
                        abrirEditarColumnasModal(tab, reporte);  // Recargar el modal
                    });
                } else {
                    Swal.fire('Error', data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'No se pudo eliminar la columna', 'error');
            });
        }
    });
}

function filtrarReportes(tabName, tabIndex) {
    const input = document.getElementById('search-' + tabIndex).value.toLowerCase();
    const ul = document.getElementById('reporte-list-' + tabIndex);
    
    fetch(`/filtrar_reportes/${tabName}?query=${input}`)
        .then(response => response.json())
        .then(data => {
            ul.innerHTML = ''; // Limpiar la lista existente
            
            // Añadir los reportes filtrados a la lista
            data.forEach(reporte => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center reporte-item';
                li.innerHTML = `
                    <div style="flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        <strong>${reporte}</strong>
                    </div>
                    <div class="btn-group ml-auto" role="group" style="white-space: nowrap;">
                        <!-- Botones de acciones -->
                        <button class="btn btn-outline-warning" onclick="abrirEditarColumnasModal('${tabName}', '${reporte}')">
                            <i class="fa fa-edit"></i> Editar
                        </button>
                        <button class="btn btn-outline-success" onclick="selectColumn('${tabName}', '${reporte}')">
                            <i class="fa fa-calculator"></i> Función
                        </button>
                        <button class="btn btn-outline-secondary" 
                                                        onclick="abrirModalConfiguracionColumnas('${tabName}', '${reporte}')"
                                                    <i class="fa fa-database"></i> Tipo de datos
                                                </button>
                        <button class="btn btn-outline-info" onclick="duplicarReporte('${tabName}', '${reporte}')">
                            <i class="fa fa-copy"></i> Duplicar
                        </button>
                        <button class="btn btn-outline-danger" onclick="eliminarReporte('${tabName}', '${reporte}')">
                            <i class="fa fa-trash-alt"></i> Eliminar
                        </button>
                    </div>
                `;
                ul.appendChild(li);
            });
        });
}



document.getElementById('search-columns').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const columnItems = document.querySelectorAll('#column-list li');
    
    columnItems.forEach(function(item) {
        const text = item.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            item.style.display = '';  // Mostrar elemento si coincide
        } else {
            item.style.display = 'none';  // Ocultar elemento si no coincide
        }
    });
});


// Declarar columnasDisponibles fuera de cualquier función para hacerlo global
let columnasDisponibles = [];

function openFunctionModal(tab, reporte, columnaSeleccionada) {
    fetch(`/edit_reporte/${reporte}?tab_name=${tab}`)
        .then(response => response.json())
        .then(data => {
            columnasDisponibles = data.columnas || [];  // Almacenar las columnas disponibles

            const columnList = document.getElementById('column-list');
            columnList.innerHTML = '';  // Limpiar cualquier contenido previo

            columnasDisponibles.forEach(col => {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item';
                listItem.textContent = col;

                // Aquí va el código de inserción en la posición del cursor
                listItem.addEventListener('click', function() {
                    const formulaText = document.getElementById('formula-text');
                    if (formulaText) {
                        // Inserta la columna donde está el cursor
                        const startPos = formulaText.selectionStart;
                        const endPos = formulaText.selectionEnd;

                        // Obtener el texto antes y después del cursor
                        const beforeInsert = formulaText.value.substring(0, startPos);
                        const afterInsert = formulaText.value.substring(endPos, formulaText.value.length);

                        // Insertar la columna en la posición del cursor
                        formulaText.value = beforeInsert + col + afterInsert;

                        // Posicionar el cursor después de la columna insertada
                        const newCursorPosition = startPos + col.length;
                        formulaText.setSelectionRange(newCursorPosition, newCursorPosition);
                        formulaText.focus();
                    } else {
                        console.error("No se encontró el elemento con ID 'formula-text' en el DOM.");
                    }
                });

                columnList.appendChild(listItem);
            });

            document.getElementById('selected-column-name').textContent = columnaSeleccionada;
            document.getElementById('formula-text').value = '';
            document.getElementById('functionModal').setAttribute('data-tab', tab);  // Aquí se asigna el tab_name
            document.getElementById('functionModal').setAttribute('data-reporte', reporte);
            document.getElementById('functionModal').setAttribute('data-columna', columnaSeleccionada);
            $('#functionModal').modal('show');
        })
        .catch(error => {
            console.error('Error al cargar las columnas:', error);
            Swal.fire('Error', 'No se pudieron cargar las columnas disponibles', 'error');
        });
}



document.getElementById('saveFormulaBtn').addEventListener('click', function() {
    // Obtener el contenido del Ace Editor
    const editor = ace.edit("ace-editor");
    const formulaContent = editor.getValue();

    // Asegurarse de que el contenido no esté vacío
    if (!formulaContent.trim()) {
        Swal.fire('Error', 'La fórmula no puede estar vacía', 'error');
        return;
    }

    // Añadir paréntesis alrededor de la fórmula para marcar que es código Python
    const pythonFormula = `(${formulaContent})`;

    // Obtener los valores necesarios del modal
    const tabName = document.getElementById('functionModal').getAttribute('data-tab');
    const reporte = document.getElementById('functionModal').getAttribute('data-reporte');
    const columna = document.getElementById('functionModal').getAttribute('data-columna');

    // Verificar que los datos estén presentes
    if (!tabName || !reporte || !columna) {
        Swal.fire('Error', 'No se pudo guardar la fórmula porque faltan datos.', 'error');
        return;
    }

    // Crear el objeto JSON para enviar al servidor
    const formulaData = {
        name: tabName,
        reporte: reporte,
        columna: columna,
        formula: pythonFormula
    };

    // Enviar la fórmula al servidor para guardarla
    fetch('/save-formula', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formulaData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire('Éxito', 'Fórmula guardada correctamente', 'success')
            .then(() => {
                $('#aceEditorModal').modal('hide');  // Cierra el modal de Ace Editor
                // Puedes agregar alguna lógica adicional para recargar la lista de fórmulas o columnas si es necesario
            });
        } else {
            Swal.fire('Error', data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error al guardar la fórmula:', error);
        Swal.fire('Error', 'No se pudo guardar la fórmula', 'error');
    });
});



// Botón para abrir el modal de agregar nueva columna
document.getElementById('addNewColumnBtn').addEventListener('click', function() {
    $('#addNewColumnModal').modal('show');
});

// Botón para guardar la nueva columna
document.getElementById('saveNewColumnBtn').addEventListener('click', function() {
    let newColumnName = document.getElementById('new_column_name').value.trim();
    const isComputedField = document.getElementById('computed_field').checked; // Verificar si el checkbox está marcado
    const tabName = document.getElementById('editColumnModal').getAttribute('data-tab');
    const reporte = document.getElementById('editColumnModal').getAttribute('data-reporte');

    // Si el checkbox está marcado, agregar "(computed)" al nombre de la columna
    if (isComputedField) {
        newColumnName += " (computed)";
    }

    if (!newColumnName) {
        Swal.fire('Error', 'El nombre de la columna no puede estar vacío.', 'error');
        return;
    }

    fetch('/add-columna', {
        method: 'POST',
        body: new URLSearchParams({
            tab_name: tabName,
            reporte: reporte,
            nueva_columna: newColumnName
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire('Éxito', 'Columna agregada correctamente', 'success')
            .then(() => {
                $('#addNewColumnModal').modal('hide');
                abrirEditarColumnasModal(tabName, reporte);  // Recargar el modal para reflejar los cambios
            });
        } else {
            Swal.fire('Error', data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'No se pudo agregar la columna', 'error');
    });
});


        function eliminarReporte(tab, reporte) {
            Swal.fire({
                title: 'Confirmar',
                text: `¿Estás seguro de que deseas eliminar el reporte "${reporte}" de la pestaña "${tab}"?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/delete-reporte', {
                        method: 'POST',
                        body: new URLSearchParams({
                            tab_name: tab,
                            reporte: reporte
                        }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire('Eliminado', 'El reporte ha sido eliminado.', 'success')
                            .then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire('Error', data.error, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Error', 'No se pudo eliminar el reporte', 'error');
                    });
                }
            });
        }

        function agregarPestaña() {
            Swal.fire({
                title: 'Nueva Pestaña',
                input: 'text',
                inputPlaceholder: 'Nombre de la nueva pestaña',
                showCancelButton: true,
                confirmButtonText: 'Agregar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    const nuevaPestaña = result.value;
                    if (nuevaPestaña) {
                        // Enviar la nueva pestaña al backend para guardarla
                        fetch('/add_tab', {
                            method: 'POST',
                            body: new URLSearchParams({
                                tab_name: nuevaPestaña
                            }),
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                location.reload(); // Recargar la página para mostrar la nueva pestaña
                            } else {
                                Swal.fire('Error', data.error, 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire('Error', 'No se pudo agregar la nueva pestaña', 'error');
                        });
                    }
                }
            });
        }

        document.getElementById('save-report-btn').addEventListener('click', function() {
            var form = document.getElementById('addReportForm');
            var tabName = document.querySelector('.nav-tabs .nav-link.active').textContent.trim(); // Obtener el nombre de la pestaña activa
            document.getElementById('tab_name').value = tabName; // Establecer el nombre de la pestaña en el formulario
            
            fetch('/add-reporte', {
                method: 'POST',
                body: new URLSearchParams(new FormData(form)),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Éxito', 'Reporte agregado correctamente', 'success')
                    .then(() => {
                        $('#addReportModal').modal('hide'); // Cierra el modal de agregar reporte
                        // Recarga la página con el parámetro de la pestaña activa
                        window.location.href = window.location.pathname + '?activeTab=' + encodeURIComponent(tabName);
                    });
                } else {
                    Swal.fire('Error', data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'No se pudo agregar el reporte', 'error');
            });
        });

        document.addEventListener('DOMContentLoaded', function() {

            $('#functionModal').on('show.bs.modal', cargarFuncionesExcel);


            // Abrir el editor avanzado (Ace Editor) para fórmulas
            document.getElementById('openAceEditorBtn').addEventListener('click', function() {
                const reporte = document.getElementById('functionModal').getAttribute('data-reporte');
                const columna = document.getElementById('functionModal').getAttribute('data-columna');
                const formula = document.getElementById('formula-text').value;

                abrirEditorFormulaAvanzada(reporte, columna, formula);
            });

            // Cargar las columnas en el modal "Editor de Fórmula Avanzada"
            $('#aceEditorModal').on('shown.bs.modal', function () {
                console.log("Se abrió el modal Editor de Fórmula Avanzada");

                const editor = ace.edit("ace-editor");
                editor.setTheme("ace/theme/monokai");
                editor.session.setMode("ace/mode/python");

                const columnList = document.getElementById('column-list-ace');
                if (columnList) {
                    columnList.innerHTML = '';  // Limpiar cualquier contenido previo

                    if (columnasDisponibles.length > 0) {
                        columnasDisponibles.forEach(col => {
                            const listItem = document.createElement('li');
                            listItem.className = 'list-group-item';
                            listItem.textContent = col;
                            listItem.addEventListener('click', function () {
                                editor.insert(col);  // Inserta la columna seleccionada en el editor
                            });
                            columnList.appendChild(listItem);
                        });
                    } else {
                        columnList.innerHTML = '<li class="list-group-item">No hay columnas disponibles.</li>';
                    }
                } else {
                    console.error("El elemento con ID 'column-list-ace' no se encontró en el DOM.");
                }
            });

                        
            
            document.getElementById('save-formula-btn').addEventListener('click', function() {
                console.log("Boton presionado!!!!!!")
                const tabName = document.getElementById('functionModal').getAttribute('data-tab');  // Obtener el nombre de la pestaña
                const reporte = document.getElementById('functionModal').getAttribute('data-reporte');
                const columna = document.getElementById('functionModal').getAttribute('data-columna');
                const formula = document.getElementById('formula-text').value;

                // Verificar que todos los datos necesarios están presentes
                if (!tabName || !reporte || !columna) {
                    Swal.fire('Error', 'No se pudo guardar la fórmula porque faltan datos.', 'error');
                    return;
                }

                console.log("Tab Name: ", tabName);
                console.log("Reporte: ", reporte);
                console.log("Columna: ", columna);

                fetch('/save-formula', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: tabName,  // Incluye el nombre de la pestaña en los datos enviados
                        reporte: reporte,
                        columna: columna,
                        formula: formula
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire('Éxito', 'Fórmula guardada correctamente', 'success')
                        .then(() => {
                            $('#functionModal').modal('hide'); // Cierra el modal de edición

                            // Volver a cargar las fórmulas para el reporte después de guardar
                            selectColumn(tabName, reporte);  // Llama a selectColumn para actualizar la lista de fórmulas

                            // Vuelve a habilitar el botón de "Añadir Función"
                            document.getElementById('addFunctionBtn').disabled = false;
                        });
                    } else {
                        Swal.fire('Error', data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire('Error', 'No se pudo guardar la fórmula', 'error');
                });
            });

            
            
            // Obtener el valor del parámetro activeTab
            const urlParams = new URLSearchParams(window.location.search);
            const activeTab = urlParams.get('activeTab');

            if (activeTab) {
                // Encontrar y activar la pestaña correspondiente
                const tabElement = Array.from(document.querySelectorAll('.nav-tabs .nav-link'))
                    .find(el => el.textContent.trim() === activeTab);
                
                if (tabElement) {
                    tabElement.click(); // Activar la pestaña
                }
            }
        });

        function cargarFuncionesExcel() {
    console.log("Cargando funciones desde el servidor...");

    // Realiza una solicitud al endpoint /get_functions para obtener las funciones
    fetch('/get_functions')
        .then(response => {
            console.log("Respuesta recibida del servidor:", response);

            if (!response.ok) {
                throw new Error("Error al obtener funciones del servidor.");
            }
            return response.json();
        })
        .then(functions => {
            console.log("Funciones recibidas:", functions);

            const functionsList = document.getElementById('excel-functions');

            if (!functionsList) {
                console.error("No se encontró el elemento con ID 'excel-functions' en el DOM.");
                return;
            }

            functionsList.innerHTML = '';  // Limpia la lista actual

            functions.forEach(func => {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item';
                listItem.textContent = func;

                // Agrega un evento al hacer clic para insertar la función en el campo de fórmula
                listItem.addEventListener('click', function() {
                    const formulaText = document.getElementById('formula-text');
                    if (formulaText) {
                        // Inserta la función donde está el cursor
                        const functionWithParentheses = `${func}()`;
                        const startPos = formulaText.selectionStart;
                        const endPos = formulaText.selectionEnd;
                        
                        // Obtener el texto antes y después del cursor
                        const beforeInsert = formulaText.value.substring(0, startPos);
                        const afterInsert = formulaText.value.substring(endPos, formulaText.value.length);
                        
                        // Insertar la función en la posición del cursor
                        formulaText.value = beforeInsert + functionWithParentheses + afterInsert;
                        formulaText.style.color = '#002A6E';  // Cambia el color del texto
                        
                        // Posicionar el cursor dentro de los paréntesis
                        const newCursorPosition = startPos + func.length + 1;  // Después de la función y antes del paréntesis de cierre
                        formulaText.setSelectionRange(newCursorPosition, newCursorPosition);
                        formulaText.focus();
                    } else {
                        console.error("No se encontró el elemento con ID 'formula-text' en el DOM.");
                    }
                });

                functionsList.appendChild(listItem);
            });
        })
        .catch(error => {
            console.error('Error al cargar las funciones:', error);
        });
}







        function abrirModalConfiguracionColumnas(tabName, reporte) {
    const configureColumnsTableBody = document.getElementById('configureColumnsTableBody');
    configureColumnsTableBody.innerHTML = '';

    fetch('/get_tipos_datos')
        .then(response => response.json())
        .then(tiposDatos => {
            fetch(`/edit_reporte/${reporte}?tab_name=${tabName}`)
                .then(response => response.json())
                .then(data => {
                    const columnas = data.columnas || [];
                    const dataTypes = data.data_types || {};
                    const columnasSinTipoDato = data.columnas_sin_tipo_dato || [];
                    console.log(columnasSinTipoDato)

                    columnas.forEach(columna => {
                        const tr = document.createElement('tr');

                        const nameTd = document.createElement('td');
                        nameTd.textContent = columna;

                        // Mostrar ícono de advertencia solo si la columna no tiene un tipo de dato asignado
                        if (columnasSinTipoDato.includes(columna)) {
                            const warningIcon = document.createElement('button');
                            warningIcon.className = 'btn btn-warning btn-sm ml-2';
                            warningIcon.innerHTML = '<i class="fa fa-exclamation-triangle"></i>';
                            warningIcon.title = 'Columna nueva, no tiene un Tipo de dato asignado';
                            nameTd.appendChild(warningIcon);
                        }

                        tr.appendChild(nameTd);

                        const dataTypeTd = document.createElement('td');
                        const select = document.createElement('select');
                        select.className = 'form-control data-type-select';

                        tiposDatos.forEach(tipo => {
                            const option = document.createElement('option');
                            option.value = tipo.tipo;
                            option.textContent = tipo.tipo;
                            if (dataTypes[columna] && dataTypes[columna].tipo === tipo.tipo) {
                                option.selected = true;
                            }
                            select.appendChild(option);
                        });

                        dataTypeTd.appendChild(select);
                        tr.appendChild(dataTypeTd);

                        const lengthTd = document.createElement('td');
                        const lengthInput = document.createElement('input');
                        lengthInput.type = 'number';
                        lengthInput.className = 'form-control length-input';
                        lengthInput.min = 0;
                        lengthInput.max = 255;

                        if (select.value === 'character varying') {
                            lengthInput.value = dataTypes[columna] && dataTypes[columna].length ? dataTypes[columna].length : 25;
                            lengthInput.disabled = false;
                        } else {
                            lengthInput.value = '';
                            lengthInput.disabled = true;
                        }

                        lengthTd.appendChild(lengthInput);
                        tr.appendChild(lengthTd);

                        configureColumnsTableBody.appendChild(tr);

                        select.addEventListener('change', function() {
                            if (this.value === 'character varying') {
                                lengthInput.disabled = false;
                                lengthInput.value = 25;
                            } else {
                                lengthInput.value = '';
                                lengthInput.disabled = true;
                            }
                        });
                    });

                    $('#configureColumnsModal').modal('show');
                })
                .catch(error => {
                    console.error('Error al cargar las columnas del reporte:', error);
                    Swal.fire('Error', 'No se pudieron cargar las columnas del reporte.', 'error');
                });
        })
        .catch(error => {
            console.error('Error al cargar los tipos de datos:', error);
            Swal.fire('Error', 'No se pudieron cargar los tipos de datos.', 'error');
        });

    document.getElementById('configureColumnsModal').setAttribute('data-tab', tabName);
    document.getElementById('configureColumnsModal').setAttribute('data-reporte', reporte);
}





        document.querySelector('form').addEventListener('submit', function(event) {
            event.preventDefault();
            var form = event.target;
            fetch('/', {
                method: 'POST',
                body: new URLSearchParams(new FormData(form)),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Éxito', 'Configuración guardada correctamente', 'success');
                } else {
                    Swal.fire('Error', data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'No se pudo guardar la configuración', 'error');
            });
        });

        function loadExistingFormulas(tab, reporte) {
            fetch(`/edit_reporte/${reporte}?tab_name=${tab}`)
                .then(response => response.json())
                .then(data => {
                    const formulas = data.formulas || {};
                    const formulasList = document.getElementById('formulas-list');
                    formulasList.innerHTML = ''; // Limpiar la lista existente

                    // Cargar las fórmulas existentes en el modal
                    Object.keys(formulas).forEach(columna => {
                        const row = document.createElement('tr');

                        const colNameCell = document.createElement('td');
                        colNameCell.textContent = columna;

                        const formulaCell = document.createElement('td');
                        formulaCell.textContent = formulas[columna];

                        const actionsCell = document.createElement('td');
                        const editBtn = document.createElement('button');
                        editBtn.className = 'btn btn-warning';
                        editBtn.innerHTML = '<i class="fa fa-edit"></i> Editar';
                        editBtn.addEventListener('click', function() {
                            editarFormula(reporte, columna, formulas[columna]);
                        });

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'btn btn-danger';
                        deleteBtn.innerHTML = '<i class="fa fa-trash-alt"></i> Eliminar';
                        deleteBtn.addEventListener('click', function() {
                            eliminarFormula(reporte, columna);
                        });

                        actionsCell.appendChild(editBtn);
                        actionsCell.appendChild(deleteBtn);

                        row.appendChild(colNameCell);
                        row.appendChild(formulaCell);
                        row.appendChild(actionsCell);

                        formulasList.appendChild(row);
                    });

                    // Mostrar el modal
                    $('#viewFormulasModal').modal('show');
                })
                .catch(error => {
                    console.error('Error al cargar las fórmulas:', error);
                    Swal.fire('Error', 'No se pudieron cargar las fórmulas existentes', 'error');
                });
        }


        function selectColumn(tab, reporte) {
    const columnSelectList = document.getElementById('column-select-list');
    columnSelectList.innerHTML = '';

    // Obtener la información del reporte, incluyendo columnas, tipos de datos y fórmulas
    fetch(`/edit_reporte/${reporte}?tab_name=${tab}`)
        .then(response => response.json())
        .then(data => {
            const columnas = data.columnas || [];
            const formulas = data.formulas || {};  // Asegurarse de que las fórmulas se obtengan correctamente
            const formulasList = document.getElementById('formulas-list');
            formulasList.innerHTML = '';

            // Mostrar las columnas que ya tienen fórmulas en el modal
            for (const [columna, formula] of Object.entries(formulas)) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${columna}</td>
                    <td>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="formula-text text-truncate" title="${formula}">
                                ${formula}
                            </span>
                            <button type="button" class="btn btn-light btn-sm ml-2" data-toggle="tooltip" data-placement="top" title="${formula}">
                                <i class="fa fa-question-circle"></i>
                            </button>
                        </div>
                    </td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-warning btn-sm" onclick="editarFormula('${reporte}', '${columna}', '${formula}')">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarFormula('${reporte}', '${columna}')">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </td>
                `;
                formulasList.appendChild(row);
            }

            // Filtrar las columnas que no tienen fórmula asignada
            const columnasSinFormula = columnas.filter(col => !(col in formulas));

            // Si no hay columnas sin fórmula, no mostrar el modal de selección de columna
            if (columnasSinFormula.length === 0) {
                Swal.fire('Información', 'Todas las columnas ya tienen una fórmula asignada.', 'info');
                return;  // Salir de la función si no hay columnas disponibles
            }

            // Mostrar solo las columnas que no tienen fórmula en el modal
            columnasSinFormula.forEach(col => {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item';
                listItem.textContent = col;
                listItem.addEventListener('click', () => {
                    $('#selectColumnModal').modal('hide');
                    openFunctionModal(tab, reporte, col);
                });
                columnSelectList.appendChild(listItem);
            });

            // Inicializar tooltips de Bootstrap después de que el contenido se ha agregado al DOM
            $(document).ready(function(){
                
            });

            // Mostrar modal con las columnas que tienen fórmulas
            $('#viewFormulasModal').modal('show');

            // Eliminar eventos anteriores del botón para evitar conflictos
            $('#addFunctionBtn').off('click');

            // Configurar el botón "Añadir Función" para abrir el modal de selección de columna
            $('#addFunctionBtn').on('click', function() {
                $('#viewFormulasModal').modal('hide'); // Asegurarse de que este modal se cierre
                $('#selectColumnModal').modal('show'); // Asegurarse de abrir el modal de selección de columna
            });
        })
        .catch(error => {
            console.error('Error al cargar las fórmulas:', error);
            Swal.fire('Error', 'No se pudieron cargar las fórmulas existentes', 'error');
        });
}

function editarFormula(reporte, columna, formula) {
    console.log("Editar fórmula:", { reporte, columna, formula }); // Debugging

    // Obtener el nombre de la pestaña activa
    const tabName = document.querySelector('.nav-tabs .nav-link.active').textContent.trim();
    console.log("Tab activa:", tabName); // Debugging

    // Verificar si la fórmula está entre paréntesis, lo cual indica que es avanzada
    const isFormulaAvanzada = formula.trim().startsWith('(') && formula.trim().endsWith(')');

    // Obtener las columnas directamente de la respuesta del servidor
    fetch(`/edit_reporte/${reporte}?tab_name=${tabName}`)
        .then(response => response.json())
        .then(data => {
            const columnas = data.columnas || [];
            console.log("Columnas disponibles:", columnas); // Debugging

            if (isFormulaAvanzada) {
                // Bloquea el área de texto si es una fórmula avanzada
                document.getElementById('formula-text').setAttribute('readonly', true);
                document.getElementById('formula-text').value = formula;
                document.getElementById('openAceEditorBtn').style.display = 'inline-block';
            } else {
                // Desbloquear el área de texto si no es avanzada
                document.getElementById('formula-text').removeAttribute('readonly');
                document.getElementById('formula-text').value = formula;
                document.getElementById('openAceEditorBtn').style.display = 'none';  // Ocultar el botón de fórmulas avanzadas
            }

            // Mostrar columnas disponibles para fórmulas simples
            const columnList = document.getElementById('column-list');
            columnList.innerHTML = '';

            columnas.forEach(col => {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item';
                listItem.textContent = col;
                listItem.addEventListener('click', () => {
                    if (!isFormulaAvanzada) {
                        document.getElementById('formula-text').value += ` ${col}`;
                    }
                });
                columnList.appendChild(listItem);
            });

            // Configurar el modal con la fórmula y columnas
            document.getElementById('selected-column-name').textContent = columna;
            document.getElementById('functionModal').setAttribute('data-reporte', reporte);
            document.getElementById('functionModal').setAttribute('data-columna', columna);
            document.getElementById('functionModal').setAttribute('data-tab', tabName);

            // Mostrar el modal
            $('#functionModal').modal('show');
        })
        .catch(error => {
            console.error('Error al obtener las columnas:', error);
            Swal.fire('Error', 'No se pudieron cargar las columnas disponibles', 'error');
        });
}


// Función para abrir el editor avanzado en Ace
function abrirEditorFormulaAvanzada(reporte, columna, formula) {
    const editor = ace.edit("ace-editor");
    editor.setTheme("ace/theme/monokai");
    editor.session.setMode("ace/mode/python");

    try {
        const formattedFormula = formula.replace(/\\n/g, '\n');
        editor.setValue(formattedFormula);
    } catch (error) {
        console.error("Error al cargar la fórmula en Ace Editor:", error);
        Swal.fire('Error', 'La fórmula no es válida para Ace Editor', 'error');
        return;
    }

    // Limpiar y mostrar las columnas en el editor avanzado
    const columnListAce = document.getElementById('column-list-ace');
    columnListAce.innerHTML = '';
    fetch(`/get_columns/${reporte}`)
        .then(response => response.json())
        .then(columnas => {
            columnas.forEach(col => {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item';
                listItem.textContent = col;
                listItem.addEventListener('click', () => {
                    editor.insert(` ${col}`);
                });
                columnListAce.appendChild(listItem);
            });
        });

    $('#aceEditorModal').modal('show');
}

// Función para abrir el modal de fórmula simple
function abrirEditorFormulaSimple(reporte, columna, formula, columnas) {
    // Limpiar la lista de columnas en el modal de fórmula sencilla
    const columnList = document.getElementById('column-list');
    columnList.innerHTML = '';

    // Agregar columnas disponibles a la lista en el modal de fórmula sencilla
    columnas.forEach(col => {
        const listItem = document.createElement('li');
        listItem.className = 'list-group-item';
        listItem.textContent = col;
        listItem.addEventListener('click', () => {
            document.getElementById('formula-text').value += ` ${col}`;
        });
        columnList.appendChild(listItem);
    });

    // Configurar el nombre de la columna y la fórmula en el modal de fórmula sencilla
    document.getElementById('selected-column-name').textContent = columna;
    document.getElementById('formula-text').value = formula;

    // Configurar los atributos del modal de fórmula sencilla
    document.getElementById('functionModal').setAttribute('data-reporte', reporte);
    document.getElementById('functionModal').setAttribute('data-columna', columna);
    document.getElementById('functionModal').setAttribute('data-tab', tabName); // Asegurar que el tab se establece

    // Mostrar el modal de fórmula sencilla
    $('#functionModal').modal('show');
}





document.getElementById('adddata').addEventListener('click', function() {
    const tabName = document.getElementById('configureColumnsModal').getAttribute('data-tab');
    const reporte = document.getElementById('configureColumnsModal').getAttribute('data-reporte');

    if (!tabName || !reporte) {
        Swal.fire('Error', 'El nombre de la pestaña y el reporte son necesarios', 'error');
        return;
    }

    const rows = document.querySelectorAll('#configureColumnsTableBody tr');
    const dataTypes = {};

    rows.forEach(row => {
        const columnName = row.querySelector('td:first-child').textContent.trim();
        const dataType = row.querySelector('select.data-type-select').value;
        const lengthInput = row.querySelector('input.length-input');
        const length = lengthInput ? lengthInput.value : null;

        dataTypes[columnName] = {
            tipo: dataType,
            length: dataType === 'character varying' ? length : null
        };
    });

    // Enviar la configuración al servidor
    fetch('/save_columns', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            dms_name: tabName,
            reporte: reporte,
            data_types: dataTypes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire('Éxito', 'Configuración guardada correctamente', 'success')
                .then(() => {
                    // Recargar la página manteniendo la pestaña actual
                    const currentUrl = new URL(window.location.href);
                    currentUrl.searchParams.set('active_tab', tabName);
                    window.location.href = currentUrl.toString();
                });
        } else {
            Swal.fire('Error', data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'No se pudo guardar la configuración de las columnas.', 'error');
    });
});


document.getElementById('addColumnBtn').addEventListener('click', function() {
    $('#addColumnModal').modal('show');
});

document.getElementById('saveColumnBtn').addEventListener('click', function() {
    const newColumnName = document.getElementById('new_column_name').value.trim();
    const tabName = document.getElementById('editColumnModal').getAttribute('data-tab');
    const reporte = document.getElementById('editColumnModal').getAttribute('data-reporte');

    if (!newColumnName) {
        Swal.fire('Error', 'El nombre de la columna no puede estar vacío.', 'error');
        return;
    }

    fetch('/add-columna', {
        method: 'POST',
        body: new URLSearchParams({
            tab_name: tabName,
            reporte: reporte,
            nueva_columna: newColumnName
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire('Éxito', 'Columna agregada correctamente', 'success')
            .then(() => {
                $('#addColumnModal').modal('hide');
                abrirEditarColumnasModal(tabName, reporte);  // Recargar el modal para reflejar los cambios
            });
        } else {
            Swal.fire('Error', data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'No se pudo agregar la columna', 'error');
    });
});

function eliminarFormula(reporte, columna) {
    const tabName = document.querySelector('.nav-tabs .nav-link.active').textContent.trim();  // Obtener el nombre de la pestaña activa

    Swal.fire({
        title: 'Confirmar',
        text: `¿Estás seguro de que deseas eliminar la fórmula para la columna "${columna}"?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch('/delete-formula', {
                method: 'POST',
                body: new URLSearchParams({
                    name: tabName,  // Enviar el nombre de la pestaña junto con los demás datos
                    reporte: reporte,
                    columna: columna
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Eliminado', 'La fórmula ha sido eliminada.', 'success')
                    .then(() => {
                        selectColumn(tabName, reporte);  // Recargar la lista de fórmulas
                    });
                } else {
                    Swal.fire('Error', data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'No se pudo eliminar la fórmula', 'error');
            });
        }
    });
}






function clearFormulaText(formulaText) {
    formulaText.innerHTML = '';  // Borra todo el contenido HTML dentro del div
    formulaText.appendChild(document.createTextNode('\u200B'));  // Agrega un espacio en blanco invisible para evitar problemas de alineación
}

function moveCaretToEnd(el) {
    el.focus();
    if (typeof window.getSelection != "undefined" && typeof document.createRange != "undefined") {
        var range = document.createRange();
        range.selectNodeContents(el);
        range.collapse(false);
        var sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
    } else if (typeof document.body.createTextRange != "undefined") {
        var textRange = document.body.createTextRange();
        textRange.moveToElementText(el);
        textRange.collapse(false);
        textRange.select();
    }
}










        function abrirModalConfiguracionColumnas(tabName, reporte) {
    const configureColumnsTableBody = document.getElementById('configureColumnsTableBody');
    configureColumnsTableBody.innerHTML = '';

    fetch('/get_tipos_datos')
        .then(response => response.json())
        .then(tiposDatos => {
            fetch(`/edit_reporte/${reporte}?tab_name=${tabName}`)
                .then(response => response.json())
                .then(data => {
                    const columnas = data.columnas || [];
                    const dataTypes = data.data_types || {};
                    const columnasSinTipoDato = data.columnas_sin_tipo_dato || [];
                    console.log(columnasSinTipoDato)

                    columnas.forEach(columna => {
                        const tr = document.createElement('tr');

                        const nameTd = document.createElement('td');
                        nameTd.textContent = columna;

                        // Mostrar ícono de advertencia solo si la columna no tiene un tipo de dato asignado
                        if (columnasSinTipoDato.includes(columna)) {
                            const warningIcon = document.createElement('button');
                            warningIcon.className = 'btn btn-warning btn-sm ml-2';
                            warningIcon.innerHTML = '<i class="fa fa-exclamation-triangle"></i>';
                            warningIcon.title = 'Columna nueva, no tiene un Tipo de dato asignado';
                            nameTd.appendChild(warningIcon);
                        }

                        tr.appendChild(nameTd);

                        const dataTypeTd = document.createElement('td');
                        const select = document.createElement('select');
                        select.className = 'form-control data-type-select';

                        tiposDatos.forEach(tipo => {
                            const option = document.createElement('option');
                            option.value = tipo.tipo;
                            option.textContent = tipo.tipo;
                            if (dataTypes[columna] && dataTypes[columna].tipo === tipo.tipo) {
                                option.selected = true;
                            }
                            select.appendChild(option);
                        });

                        dataTypeTd.appendChild(select);
                        tr.appendChild(dataTypeTd);

                        const lengthTd = document.createElement('td');
                        const lengthInput = document.createElement('input');
                        lengthInput.type = 'number';
                        lengthInput.className = 'form-control length-input';
                        lengthInput.min = 0;
                        lengthInput.max = 255;

                        if (select.value === 'character varying') {
                            lengthInput.value = dataTypes[columna] && dataTypes[columna].length ? dataTypes[columna].length : 25;
                            lengthInput.disabled = false;
                        } else {
                            lengthInput.value = '';
                            lengthInput.disabled = true;
                        }

                        lengthTd.appendChild(lengthInput);
                        tr.appendChild(lengthTd);

                        configureColumnsTableBody.appendChild(tr);

                        select.addEventListener('change', function() {
                            if (this.value === 'character varying') {
                                lengthInput.disabled = false;
                                lengthInput.value = 25;
                            } else {
                                lengthInput.value = '';
                                lengthInput.disabled = true;
                            }
                        });
                    });

                    $('#configureColumnsModal').modal('show');
                })
                .catch(error => {
                    console.error('Error al cargar las columnas del reporte:', error);
                    Swal.fire('Error', 'No se pudieron cargar las columnas del reporte.', 'error');
                });
        })
        .catch(error => {
            console.error('Error al cargar los tipos de datos:', error);
            Swal.fire('Error', 'No se pudieron cargar los tipos de datos.', 'error');
        });

    document.getElementById('configureColumnsModal').setAttribute('data-tab', tabName);
    document.getElementById('configureColumnsModal').setAttribute('data-reporte', reporte);
}





        document.querySelector('form').addEventListener('submit', function(event) {
            event.preventDefault();
            var form = event.target;
            fetch('/', {
                method: 'POST',
                body: new URLSearchParams(new FormData(form)),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Éxito', 'Configuración guardada correctamente', 'success');
                } else {
                    Swal.fire('Error', data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'No se pudo guardar la configuración', 'error');
            });
        });

        function loadExistingFormulas(tab, reporte) {
            fetch(`/edit_reporte/${reporte}?tab_name=${tab}`)
                .then(response => response.json())
                .then(data => {
                    const formulas = data.formulas || {};
                    const formulasList = document.getElementById('formulas-list');
                    formulasList.innerHTML = ''; // Limpiar la lista existente

                    // Cargar las fórmulas existentes en el modal
                    Object.keys(formulas).forEach(columna => {
                        const row = document.createElement('tr');

                        const colNameCell = document.createElement('td');
                        colNameCell.textContent = columna;

                        const formulaCell = document.createElement('td');
                        formulaCell.textContent = formulas[columna];

                        const actionsCell = document.createElement('td');
                        const editBtn = document.createElement('button');
                        editBtn.className = 'btn btn-warning';
                        editBtn.innerHTML = '<i class="fa fa-edit"></i> Editar';
                        editBtn.addEventListener('click', function() {
                            editarFormula(reporte, columna, formulas[columna]);
                        });

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'btn btn-danger';
                        deleteBtn.innerHTML = '<i class="fa fa-trash-alt"></i> Eliminar';
                        deleteBtn.addEventListener('click', function() {
                            eliminarFormula(reporte, columna);
                        });

                        actionsCell.appendChild(editBtn);
                        actionsCell.appendChild(deleteBtn);

                        row.appendChild(colNameCell);
                        row.appendChild(formulaCell);
                        row.appendChild(actionsCell);

                        formulasList.appendChild(row);
                    });

                    // Mostrar el modal
                    $('#viewFormulasModal').modal('show');
                })
                .catch(error => {
                    console.error('Error al cargar las fórmulas:', error);
                    Swal.fire('Error', 'No se pudieron cargar las fórmulas existentes', 'error');
                });
        }



        function editarFormula(reporte, columna, formula) {
    console.log("Editar fórmula:", { reporte, columna, formula }); // Debugging

    // Obtener el nombre de la pestaña activa
    const tabName = document.querySelector('.nav-tabs .nav-link.active').textContent.trim();
    console.log("Tab activa:", tabName); // Debugging

    // Obtener las columnas directamente de la respuesta del servidor
    fetch(`/edit_reporte/${reporte}?tab_name=${tabName}`)
        .then(response => response.json())
        .then(data => {
            const columnas = data.columnas || [];
            console.log("Columnas disponibles:", columnas); // Debugging

            // Limpiar la lista de columnas en el modal
            const columnList = document.getElementById('column-list');
            columnList.innerHTML = '';

            // Agregar columnas disponibles a la lista en el modal
            columnas.forEach(col => {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item';
                listItem.textContent = col;
                listItem.addEventListener('click', () => {
                    document.getElementById('formula-text').value += ` ${col}`;
                });
                columnList.appendChild(listItem);
            });

            // Configurar el nombre de la columna y la fórmula en el modal
            document.getElementById('selected-column-name').textContent = columna;
            document.getElementById('formula-text').value = formula;

            // Configurar los atributos del modal
            document.getElementById('functionModal').setAttribute('data-reporte', reporte);
            document.getElementById('functionModal').setAttribute('data-columna', columna);
            document.getElementById('functionModal').setAttribute('data-tab', tabName); // Asegurar que el tab se establece

            // Mostrar el modal de edición de fórmula
            $('#functionModal').modal('show');
        })
        .catch(error => {
            console.error('Error al obtener las columnas:', error);
            Swal.fire('Error', 'No se pudieron cargar las columnas disponibles', 'error');
        });
}


document.getElementById('adddata').addEventListener('click', function() {
    const tabName = document.getElementById('configureColumnsModal').getAttribute('data-tab');
    const reporte = document.getElementById('configureColumnsModal').getAttribute('data-reporte');

    if (!tabName || !reporte) {
        Swal.fire('Error', 'El nombre de la pestaña y el reporte son necesarios', 'error');
        return;
    }

    const rows = document.querySelectorAll('#configureColumnsTableBody tr');
    const dataTypes = {};

    rows.forEach(row => {
        const columnName = row.querySelector('td:first-child').textContent.trim();
        const dataType = row.querySelector('select.data-type-select').value;
        const lengthInput = row.querySelector('input.length-input');
        const length = lengthInput ? lengthInput.value : null;

        dataTypes[columnName] = {
            tipo: dataType,
            length: dataType === 'character varying' ? length : null
        };
    });

    // Enviar la configuración al servidor
    fetch('/save_columns', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            dms_name: tabName,
            reporte: reporte,
            data_types: dataTypes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire('Éxito', 'Configuración guardada correctamente', 'success')
                .then(() => {
                    // Recargar la página manteniendo la pestaña actual
                    const currentUrl = new URL(window.location.href);
                    currentUrl.searchParams.set('active_tab', tabName);
                    window.location.href = currentUrl.toString();
                });
        } else {
            Swal.fire('Error', data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'No se pudo guardar la configuración de las columnas.', 'error');
    });
});


document.getElementById('addColumnBtn').addEventListener('click', function() {
    $('#addColumnModal').modal('show');
});

document.getElementById('saveColumnBtn').addEventListener('click', function() {
    const newColumnName = document.getElementById('new_column_name').value.trim();
    const tabName = document.getElementById('editColumnModal').getAttribute('data-tab');
    const reporte = document.getElementById('editColumnModal').getAttribute('data-reporte');

    if (!newColumnName) {
        Swal.fire('Error', 'El nombre de la columna no puede estar vacío.', 'error');
        return;
    }

    fetch('/add-columna', {
        method: 'POST',
        body: new URLSearchParams({
            tab_name: tabName,
            reporte: reporte,
            nueva_columna: newColumnName
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire('Éxito', 'Columna agregada correctamente', 'success')
            .then(() => {
                $('#addColumnModal').modal('hide');
                abrirEditarColumnasModal(tabName, reporte);  // Recargar el modal para reflejar los cambios
            });
        } else {
            Swal.fire('Error', data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'No se pudo agregar la columna', 'error');
    });
});

function eliminarFormula(reporte, columna) {
    const tabName = document.querySelector('.nav-tabs .nav-link.active').textContent.trim();  // Obtener el nombre de la pestaña activa

    Swal.fire({
        title: 'Confirmar',
        text: `¿Estás seguro de que deseas eliminar la fórmula para la columna "${columna}"?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch('/delete-formula', {
                method: 'POST',
                body: new URLSearchParams({
                    name: tabName,  // Enviar el nombre de la pestaña junto con los demás datos
                    reporte: reporte,
                    columna: columna
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Eliminado', 'La fórmula ha sido eliminada.', 'success')
                    .then(() => {
                        selectColumn(tabName, reporte);  // Recargar la lista de fórmulas
                    });
                } else {
                    Swal.fire('Error', data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'No se pudo eliminar la fórmula', 'error');
            });
        }
    });
}



function abrirFiltroModal(columnName) {
    const filterColumnNameElement = document.getElementById('filterColumnName');

    // Verificamos si el elemento existe en el DOM
    if (filterColumnNameElement) {
        filterColumnNameElement.textContent = columnName;
    } else {
        console.error("El elemento filterColumnName no se encontró en el DOM.");
    }

    // Abrimos el modal
    $('#filterModal').modal('show');
}


// Cuando el checkbox de Left Function esté seleccionado, habilitamos el input para el número de caracteres
document.getElementById('useLeftFunction').addEventListener('change', function() {
    document.getElementById('leftCharacters').disabled = !this.checked;
});

// Función para construir el filtro
document.getElementById('applyFilterBtn').addEventListener('click', function() {
    const column = document.getElementById('filterColumn').value;
    const condition = document.getElementById('condition').value;
    const filterValue = document.getElementById('filterValue').value;
    const includeEmptyField = document.getElementById('includeEmptyField').checked;
    const useLeftFunction = document.getElementById('useLeftFunction').checked;
    const leftCharacters = document.getElementById('leftCharacters').value;

    let filterExpression = "";

    // Primera condición: columna no vacía
    if (includeEmptyField) {
        filterExpression += `[${column}]<>""`;
    }

    // Condición adicional con función LEFT
    if (useLeftFunction) {
        if (filterExpression !== "") {
            filterExpression += " .and. ";
        }
        filterExpression += `left([${column}], ${leftCharacters}) ${condition} "${filterValue}"`;
    } else {
        if (filterExpression !== "") {
            filterExpression += " .and. ";
        }
        filterExpression += `[${column}] ${condition} "${filterValue}"`;
    }

    // Mostrar el filtro generado en consola o puedes asignarlo a un campo oculto o procesarlo como necesites
    console.log(filterExpression);
    
    // Aquí podrías cerrar el modal o hacer alguna acción con el filtro generado
    $('#filterModal').modal('hide');
});




function duplicarReporte(tab, reporte) {
    // Obtener los tabs disponibles desde el servidor
    fetch('/get_tabs_json')
        .then(response => response.json())
        .then(tabs => {
            let optionsHtml = '';

            // Crear las opciones para el select
            tabs.forEach(tabName => {
                const selected = tabName === tab ? 'selected' : '';  // Seleccionar por defecto el tab actual
                optionsHtml += `<option value="${tabName}" ${selected}>${tabName}</option>`;
            });

            Swal.fire({
                title: 'Duplicar Reporte',
                html: `
                    <div style="text-align: left; font-size: 14px;">
                        <p style="margin-bottom: 10px;">Estás a punto de duplicar el reporte <strong>"${reporte}"</strong>.</p>
                        
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <label for="nuevo_nombre_reporte" style="flex: 1;">Nuevo nombre del reporte:</label>
                            <input type="text" id="nuevo_nombre_reporte" class="swal2-input" placeholder="Nuevo nombre del reporte" style="width: 60%; font-size: 14px;">
                        </div>

                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <label for="dms_select" style="flex: 1;">Selecciona el DMS de destino:</label>
                            <select id="dms_select" class="swal2-input" style="width: 60%; font-size: 14px;">
                                ${optionsHtml}
                            </select>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Duplicar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const nuevoNombreReporte = document.getElementById('nuevo_nombre_reporte').value.trim();
                    const dmsDestino = document.getElementById('dms_select').value;

                    if (!nuevoNombreReporte) {
                        Swal.showValidationMessage('El nombre del nuevo reporte no puede estar vacío');
                        return false;
                    }

                    return { nuevoNombreReporte, dmsDestino };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const { nuevoNombreReporte, dmsDestino } = result.value;

                    // Hacer la petición para duplicar el reporte
                    fetch('/duplicar-reporte', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams({
                            tab_name: tab,
                            reporte: reporte,
                            nuevo_reporte: nuevoNombreReporte,
                            dms_destino: dmsDestino
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire('¡Éxito!', 'El reporte ha sido duplicado correctamente', 'success')
                            .then(() => {
                                location.reload();  // Recargar la página para ver el nuevo reporte
                            });
                        } else {
                            Swal.fire('Error', data.error, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Error', 'No se pudo duplicar el reporte', 'error');
                    });
                }
            });
        })
        .catch(error => {
            console.error('Error al obtener los tabs:', error);
            Swal.fire('Error', 'No se pudieron cargar las opciones de DMS', 'error');
        });
}


$('#configureColumnsModal').modal('show');


$(document).ready(function(){
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    $('#configureColumnsModal').on('shown.bs.modal', function () {
                    alert('Modal mostrado correctamente');
    });
});

    </script>
</body>
{% endblock %}
</html>
